name: "Create Shopify Theme Preview"
description: "Create a Shopify Theme Preview - replies with new comment each time"
inputs:
  shopify_flag_store:
    description: "Store URL, like your-store.myshopify.com"
    required: true
  shopify_cli_theme_token:
    description: "Password generated from Theme Access app"
    required: true
  build_step:
    description: "Command used as build step"
    default: 'echo "No build step"'
    required: false
  dir:
    description: "Directory to preview."
    default: "."
    required: false
  timezone:
    description: "TZ identifier"
    required: false
    default: "UTC"

runs:
  using: "composite"
  steps:
    - name: Set timezone
      uses: szenius/set-timezone@v1.2
      with:
        timezoneLinux: ${{ inputs.timezone }}
    - name: Get Date
      id: date
      shell: bash
      run: echo "date=$(date +'%d-%m-%Y ')" >> $GITHUB_OUTPUT
    - name: Get Time
      id: time
      run: echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT
      shell: bash
    - name: Comment Loading
      id: create-comment
      uses: peter-evans/create-or-update-comment@v4
      with:
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          **Shopify Theme Preview**

          | Name | Status | Preview | Editor | Date | Time |
          | :--- | :----- | :------ | :------ | :------ | :----- |
          | ${{ inputs.shopify_flag_store }} | :hourglass_flowing_sand: Loading |  |  | ${{ steps.date.outputs.date }} | ${{ steps.time.outputs.time }}
    - uses: actions/setup-node@v4
      with:
        node-version: 18
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1
        bundler: "latest"
    - name: Install Shopify CLI
      run: npm install -g @shopify/cli@3.83.3
      shell: bash
    - name: Check Version
      run: shopify version
      shell: bash
    - name: Build step
      run: ${{ inputs.build_step }}
      shell: bash
    - name: Create Preview Link
      id: link
      shell: bash
      env:
        SHOPIFY_FLAG_STORE: ${{ inputs.shopify_flag_store }}
        SHOPIFY_CLI_THEME_TOKEN: ${{ inputs.shopify_cli_theme_token }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
      run: |
        echo 'JSON_RESPONSE<<EOF' >> $GITHUB_OUTPUT
        shopify theme push --json --unpublished --theme "Preview PR #${PR_NUMBER}" --path ${{ inputs.dir}} >> $GITHUB_OUTPUT || true
        echo 'EOF' >> $GITHUB_OUTPUT
    - name: Format Data
      run: |
        echo '${{ steps.link.outputs.JSON_RESPONSE }}' > 'temp.txt'
        echo 'LINK<<DEL' >> $GITHUB_OUTPUT
        tail -n1 temp.txt >> $GITHUB_OUTPUT
        echo 'DEL' >> $GITHUB_OUTPUT
      id: temp
      shell: bash
    - name: Comment Link
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ steps.create-comment.outputs.comment-id }}
        body: |
          **Shopify Theme Preview**

          | Name | Status | Preview | Editor | Date | Time |
          | :--- | :----- | :------ | :------ | :------ | :----- |
          | ${{ inputs.shopify_flag_store }} | :white_check_mark: Ready | <a href="${{ fromJSON(steps.temp.outputs.LINK).theme.preview_url }}" target="_blank">Preview</a> | [Editor](${{ fromJSON(steps.temp.outputs.LINK).theme.editor_url }}) | ${{ steps.date.outputs.date }} | ${{ steps.time.outputs.time }}
        reactions: hooray
        edit-mode: replace
    - name: Output Step Failed
      if: ${{ failure() }}
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ steps.create-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        body: |
          **Shopify Theme Preview**

          | Name | Status | Preview | Editor | Date | Time |
          | :--- | :----- | :------ | :------ | :------ | :----- |
          | ${{ inputs.shopify_flag_store }} | :x: Failed |  |  | ${{ steps.date.outputs.date }} | ${{ steps.time.outputs.time }}

          :x: 'Create Preview Link' failed :x:

          Please check if the following `inputs` are set correctly:
          - `shopify_cli_theme_token` [(?)](https://shopify.dev/themes/tools/theme-access)
          - `shopify_flag_store`
        edit-mode: replace
